{% extends "layout.html" %}
{% block content %}
<p>Total Patients: {{ count }}</p>
<p>Time to fetch details: {{ time.total_seconds() }} seconds</p>

<style>
    .charts-container {
        display: flex;
        justify-content: space-between;
    }

    .chart-column {
        flex: 1;
        margin: 10px;
    }

    #bmi-histogram-chart {
         /* Background color for the chart container */
        border-radius: 8px; /* Rounded corners for the chart container */
    }
    .charts-container.row {
        display: flex;
        flex-wrap: wrap;
    }

    .charts-container.row .chart-column {
        flex: 1;
        margin-right: 10px; /* Adjust the margin as needed */
    }

    .heatmap-full-width {
        width: 100%;
    }

    .smaller-chart {
        flex-basis: 30%; /* Adjust the width as needed */
        max-width: 300px; /* Adjust the max width as needed */
    }
</style>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Patient Count</th>
            <th>Percentage</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in result %}
        <tr>
            <td><a href="javascript:void(0)" class="myButton" data-entry="{{ entry }}"
                heat-entry='{{ symptom_data_by_diagnosis_age_range[entry['Diagnosis Name']] | tojson }}'>
                {{ entry['Diagnosis Name'] }}</a>
            </td>
            <td>{{ entry["patient_count"] }}</td>
            <td>{{ entry["percentage"] }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="charts-container row">
    <div class="chart-column">
        <canvas id="bar-chart"></canvas>
    </div>
    <div class="chart-column">
        <canvas id="region-chart"></canvas>
    </div></div>
<div class="charts-container row">
    <div class="heatmap-full-width">
        <div id="heatmap"></div>
    </div>
</div>
<div class="charts-container row">
    <div class="chart-column">
        <canvas id="bmi-histogram-chart"></canvas>
    </div>
    <div class="chart-column">
        <canvas id="symptoms-chart"></canvas>
    </div>
    <button id="toggle-button">Toggle Symptoms</button>
</div>
<div id="chart-container row">
    <div class="chart-column smaller-chart">
        <canvas id="sex-pie-chart"></canvas>
    </div>
</div>

<div class="charts-container row">
    <div class="chart-column">
        <canvas id="medications-pie-chart"></canvas>
    </div>
    <div class="chart-column">
        <canvas id="family-history-chart"></canvas>
    </div>
</div>
<div class="chart-container row">
    <canvas id="region-symptoms-chart"></canvas>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
    const regionCanvas = document.getElementById("region-chart");
    const regionCtx = regionCanvas.getContext("2d");
    const chartCanvas = document.getElementById("bar-chart");
    const symptomsCanvas = document.getElementById("symptoms-chart");
    const heatmapCanvas = document.getElementById("heatmap-chart");
    const ctx = chartCanvas.getContext("2d");
    const symptomsCtx = symptomsCanvas.getContext("2d");
    const bmiHistogramCanvas = document.getElementById("bmi-histogram-chart");
    const bmiHistogramCtx = bmiHistogramCanvas.getContext("2d");
    let bmiHistogramChart = null;
    let chart = null;
    let symptomsChart = null;
    let regionChart = null; 
    let heatmapChart = null;
    const sexCanvas = document.getElementById("sex-pie-chart");
    const sexCtx = sexCanvas.getContext("2d");
    let sexPieChart = null;
    const medicationsCanvas = document.getElementById("medications-pie-chart");
    const medicationsCtx = medicationsCanvas.getContext("2d");
    let medicationsPieChart = null;
    let family_historychart = null;
    const family_historyCanvas = document.getElementById("family-history-chart");
    const family_historyCtx = family_historyCanvas.getContext("2d");
    const regionSymptomsCanvas = document.getElementById("region-symptoms-chart");
    const regionSymptomsCtx = regionSymptomsCanvas.getContext("2d");
    let regionSymptomsChart = null
    

    function createHeatmap(heatmapData) {
        const layout = {
            xaxis: { title: 'Age Group' },
            yaxis: { title: 'Symptoms' },
        };

        const heatmapContainer = document.getElementById("heatmap");

        if (heatmapContainer.data) {
            Plotly.purge(heatmapContainer);
        }

        Plotly.newPlot(heatmapContainer, [heatmapData], layout);
    }

    function createRegionSymptomsChart(data) {
    // Ensure the existing region-symptoms-chart is destroyed if it exists
        if (regionSymptomsChart) {
            regionSymptomsChart.destroy();
        }
        console.log("data", data);
        const labels = data.top_symptoms;
        const regionData = data.region_data;
        const regionColors = [
            "#FF5733", // Color for region 1
            "#FFC300", // Color for region 2
            "#C70039", // Color for region 3
            "#581845", // Color for region 4
            "#900C3F", // Color for region 5
        ];
        regionSymptomsChart = new Chart(regionSymptomsCtx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: regionData.columns.map((column, index) => ({
                    label: regionData.index[index],
                    data: regionData.data[index],
                    backgroundColor: regionColors[index],
            })),
            },
            options: {
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                    },
                },
            },
        });
    }


    function createMedicationsPieChart(data) {
        if (medicationsPieChart) {
            medicationsPieChart.destroy();
        }
        medicationsPieChart = new Chart(medicationsCtx, {
            type: "bar",
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: "Medications",
                        data: data.data,
                        backgroundColor: [
                            "#FF5733",
                            "#FFC300",
                            "#C70039",
                            "#581845",
                            "#900C3F",
                            "#FFA07A",
                            "#FF5733"
                        ],
                    },
                ],
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Count",
                        },
                    },
                    x: {
                        title: {
                            display: true,
                            text: "Medications",
                        },
                    },
                },
            },
        });
    }

    function createfamily_history(data) {
        if (family_historychart) {
            family_historychart.destroy();
        }
        family_historychart = new Chart(family_historyCtx, {
            type: "bar",
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: "Family History",
                        data: data.data,
                        backgroundColor: [
                            "#FF5733",
                            "#FFC300",
                            "#C70039",
                            "#581845",
                            "#900C3F",
                            "#FFA07A",
                            "#FF5733"
                        ],
                    },
                ],
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Count",
                        },
                    },
                    x: {
                        title: {
                            display: true,
                            text: "Medications",
                        },
                    },
                },
            },
        });
    }

    function createBMIHistogram(data) {
        if (bmiHistogramChart) {
            bmiHistogramChart.destroy();
        }

        bmiHistogramChart = new Chart(bmiHistogramCtx, {
            type: "bar",
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: "BMI Index",
                        data: data.histogram_data,
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Number of Patients",
                        },
                    },
                    x: {
                        title: {
                            display: true,
                            text: "BMI Index",
                        },
                    },
                },
            },
        });
    }

    


    function createBarChart(data) {
        if (chart) {
            chart.destroy();
        }

        chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: "Daily",
                        data: data.daily_count,
                        backgroundColor: "rgba(128, 0, 0, 0.5)",  // Dark red
                    },
                    {
                        label: "Never",
                        data: data.never_count,
                        backgroundColor: "rgba(0, 0, 128, 0.5)",  // Dark blue
                    },
                    {
                        label: "Occasionally",
                        data: data.occasionally_count,
                        backgroundColor: "rgba(128, 128, 0, 0.5)",  // Dark yellow
                    },
                    {
                        label: "Quit Smoking",
                        data: data.quit_smoking_count,
                        backgroundColor: "rgba(0, 128, 128, 0.5)",  // Dark cyan
                    },
                ],
            },
        });
    }

    function createRegionChart(data){
        if(regionChart) {
            regionChart.destroy();
        }
        const labels = Object.keys(data);
        const counts = Object.values(data);
        regionChart = new Chart(regionCtx,{
            type: "bar",
            data : {
                labels: labels,
                datasets: [
                    {   label: "Patient count by region wise",
                        data: counts,
                        backgroundColor: "rgba(0, 128, 128, 0.5)",
                    },
                ],
            },
        });
      
    }

    function createSexPieChart(data) {
        if (sexPieChart) {
            sexPieChart.destroy();
        }

        sexPieChart = new Chart(sexCtx, {
            type: "pie",
            data: {
                labels: data.labels,
                datasets: [
                    {
                        data: data.data,
                        backgroundColor: ["#36A2EB", "#FFCE56"], // Blue for male, yellow for female
                    },
                ],
            },
        });
    }

    function createSymptomsChart(data) {
        if (symptomsChart) {
            symptomsChart.destroy();
        }
        console.log(data);
        symptomsChart = new Chart(symptomsCtx, {
            type: "bar",
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: "Top Symptoms",
                        data: data.percentages,
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Percentage (%)",
                        },
                    },
                    x: {
                        title: {
                            display: true,
                            text: "Symptoms",
                        },
                    },
                },
            },
        });
    }

    
    // Function to handle button click
    function handleButtonClick(event) {
        const clickedButton = event.target;
        const entryData = JSON.parse(clickedButton.getAttribute("data-entry").split("'").join('"'));
        const heatData = JSON.parse(clickedButton.getAttribute("heat-entry"));
        const newdata = Object.values(heatData);
        const keys = Object.keys(newdata[1]);
        if (family_historychart) {
            family_historychart.destroy();
        }
        const valuesByKeys = {};
        keys.forEach(key => {
            valuesByKeys[key] = [];
        });

        for (const key in newdata) {
            keys.forEach(keyName => {
                valuesByKeys[keyName].push(newdata[key][keyName]);
            });
        }
        const heatmapData = {
            x: Object.keys(heatData),
            y: keys,
            z: keys.map(key => valuesByKeys[key]),
            type: 'heatmap',
            colorscale: 'Viridis',
        }
        createHeatmap(heatmapData);


        const data = {
            labels: [entryData["Diagnosis Name"]],
            daily_count: [entryData["daily_count"]],
            never_count: [entryData["never_count"]],
            occasionally_count: [entryData["occasionally_count"]],
            quit_smoking_count: [entryData["quit_smoking_count"]],
        };

        createBarChart(data);

        const bmiHistogramData = {{ bmi_histogram_dict|tojson|safe }};
        const diagnosisName = entryData["Diagnosis Name"];
        const symptomsData = {{ symptom_data_by_diagnosis|tojson|safe }};
        const regionData = {{ region_counts|tojson|safe }};
        const symptom_data_by_diagnosis_agerange = {{ symptom_data_by_diagnosis_age_range|tojson|safe}}; 
        const medicationsChartData = {{ medications_chart_data_|safe }};
        const regionChartData = regionData[entryData["Diagnosis Name"]];
        if (symptomsData[diagnosisName]) {
            const topSymptoms = symptomsData[diagnosisName].top_symptoms;
            const percentages = symptomsData[diagnosisName].percentage;
            const symptomsChartData = {
                labels: topSymptoms,
                percentages: percentages,
            };

            createSymptomsChart(symptomsChartData);
        }
        if(regionChartData){
            createRegionChart(regionChartData);
        }
        const sexChartData = {{ gender_chart|safe }};
        if (sexChartData[diagnosisName]) {
            createSexPieChart(sexChartData[diagnosisName]);
        }

        if (medicationsChartData[diagnosisName]) {
            createMedicationsPieChart(medicationsChartData[diagnosisName]);
        }

        const family_history_data = {{ family_history_by_diagnosis_json | safe}};
        if(family_history_data[diagnosisName]){
            createfamily_history(family_history_data[diagnosisName]);
        }
        const bmiHistogramData_diagnosis = bmiHistogramData[diagnosisName];

        if (bmiHistogramData) {
            const bmiLabels = Object.keys(bmiHistogramData_diagnosis);
            const bmiHistogramChartData = {
                labels: bmiLabels,
                histogram_data: bmiLabels.map(label => bmiHistogramData_diagnosis[label]),
            };

            createBMIHistogram(bmiHistogramChartData);
         }
        const regionSymptomData = {{ region_symptom_data|safe }};
        // Inside your handleButtonClick function:
        if (regionSymptomData[diagnosisName]) {
            console.log("inside region symptoms")
            const regionSymptomsData = regionSymptomData[diagnosisName];
            createRegionSymptomsChart(regionSymptomsData);
        }
    }   

    const buttons = document.querySelectorAll(".myButton");

    buttons.forEach((button) => {
        button.addEventListener("click", handleButtonClick);
    });
</script>
{% endblock %}
