{% extends "layout.html" %}
{% block content %}
<p>Total Patients: {{ count }}</p>
<p>Time to fetch details: {{ time.total_seconds() }} seconds</p>

<style>
    /* Define the CSS styles for the heatmap */
    .heatmap {
        display: grid;
        grid-template-columns: repeat(9, 180px);
        grid-template-rows: repeat(9, 40px); /* Adjust the number of rows as needed */
        grid-gap: 1px;
    }

    .cell {
        width: 180px;
        height: 40px;
        text-align: center;
        vertical-align: middle;
        background-color: lightblue;
        border: 1px solid #fff;
    }
</style>


<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Patient Count</th>
            <th>Percentage</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in result %}
        <tr>
            <td><a href="javascript:void(0)" class="myButton" data-entry="{{ entry }}">{{ entry['Diagnosis Name'] }}</a>
            </td>
            <td>{{ entry["patient_count"] }}</td>
            <td>{{ entry["percentage"] }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="chart-container" class="flex flex-col">
    <div><canvas id="bar-chart"></canvas></div>
    <div><canvas id="pie-chart"></canvas></div>
</div>
<div class="heatmap" id="heatmap"></div>

<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
    // Your data
    var data = {{ symptom_data_by_diagnosis_age_range | tojson  }}

    // Convert your data into an array for D3.js
    var diseaseNames = Object.keys(data);
    var timeIntervals = Object.keys(data[diseaseNames[0]]);
    var symptom = "Nausea";

    var heatmapData = [];

    diseaseNames.forEach(function(disease) {
        var row = [];
        timeIntervals.forEach(function(interval) {
            row.push(data[disease][interval][symptom]);
        });
        heatmapData.push(row);
    });

    // Create the heatmap using D3.js
    var heatmap = d3.select("#heatmap")
        .selectAll(".row")
        .data(heatmapData)
        .enter().append("div")
        .attr("class", "row");

    heatmap.selectAll(".cell")
        .data(function (d) { return d; })
        .enter().append("div")
        .attr("class", "cell")
        .style("background-color", function(d) {
            // Customize the color scale based on your data values
            return "rgb(0, 0, " + (d * 10) + ")";
        })
        .text(function(d) { return d; });

    // Add labels to the y-axis (left side)
    heatmap.append("div")
        .attr("class", "cell axis-label")
        .text(function (d, i) {
            return diseaseNames[i];
        });

    // Add labels to the x-axis (top)
    d3.select("#heatmap")
        .append("div")
        .attr("class", "row")
        .selectAll(".cell")
        .data(timeIntervals)
        .enter().append("div")
        .attr("class", "cell axis-label")
        .text(function (d) {
            return d;
        });
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const chartContainer = document.getElementById("chart-container");
    const barChartCanvas = document.getElementById("bar-chart");
    const pieChartCanvas = document.getElementById("pie-chart");
    const ctx_bar = barChartCanvas.getContext("2d");
    const ctx_pie = pieChartCanvas.getContext("2d");
    let chartbar = null, chartpie = null;

    function createBarChart(data) {
        if (chartbar) {
            chartbar.destroy();
        }

        chartbar = new Chart(ctx_bar, {
            type: "bar",
            data: data,
        });
    }

    function createPieChart(pieData) {
        if (chartpie) {
            chartpie.destroy();
        }

        chartpie = new Chart(ctx_pie, {
            type: "pie",
            data: pieData,
        });
    }

    // Function to handle button click
    function handleButtonClick(event) {
        const clickedButton = event.target;
        const entryData = JSON.parse(clickedButton.getAttribute("data-entry").split("'").join('"'));

        console.log(entryData);
        const data = {
            labels: [entryData["Diagnosis Name"]],
            datasets: [
                {
                    label: "Patient Count",
                    data: [entryData["patient_count"]],
                    backgroundColor: "rgba(255, 99, 132, 0.5)",
                },
            ],
        };

        const pieData = {
            labels: ["Daily", "Never", "Occasionally", "Quit Smoking"],
            datasets: [
                {
                    label: "Smoking stats",
                    data: [entryData["daily_count"], entryData["never_count"], entryData["occasionally_count"], entryData["quit_smoking_count"]],
                    backgroundColor: [
                        "rgba(255, 99, 132, 0.5)",  // Color for "Daily"
                        "rgba(54, 162, 235, 0.5)",  // Color for "Never"
                        "rgba(255, 206, 86, 0.5)",  // Color for "Occasionally"
                        "rgba(75, 192, 192, 0.5)",  // Color for "Quit Smoking"
                    ],
                },
            ],
        };


        createBarChart(data);
        createPieChart(pieData);
    }

    const buttons = document.querySelectorAll(".myButton");

    buttons.forEach((button) => {
        button.addEventListener("click", handleButtonClick);
    });
</script>

{% endblock %}